# 15_rollback_procedures.md  
Ultra AutoTrade – ロールバック手順

---

# 1. ロールバックの目的
誤作動・暴落・通信障害などで  
資金損失を防ぐための“即時復旧”手順。

---

# 2. 取引ステップ別ロールバック

## 2.1 Notion → AI
失敗時は Notion の該当ブロックを “再処理キュー” に移動。

## 2.2 AI → OctoBot
OctoBot API失敗時：

- 3回リトライ  
- 失敗時は “HOLD 判定” 処理に切り替え  
- 同時に手動確認通知

## 2.3 OctoBot → Aave
Aave deposit 失敗時：

- ガスリトライ  
- ガス高騰時は自動キャンセル  
- 失敗ログを Notion に保存  

withdraw 失敗時：

- Gas不足でない場合は即緊急通知

## 2.4 Aave 操作失敗時（/aave/rebalance）

### 失敗パターン
- Aave クライアントエラー（RPC 断、レスポンス異常）
- ヘルスファクター取得失敗
- 想定外の例外

### Phase4 実装での挙動
- deposit / withdraw 前にヘルスファクター取得を試みる（失敗時は None として継続）
- `BUY/SELL/HOLD` → `DEPOSIT/WITHDRAW/NOOP` 判定後、
  - クライアント例外が発生した場合は
    - 実際のトランザクションは送られない
    - `status="error"`, `amount=0` として API レスポンスを返す
- いかなるエラー時も **「ポジションを増やす方向の変更は行わない」** ことを保証する

### 運用側でのロールバック対応
- Aave 関連でエラーが連続した場合：
  - OctoBot シグナル → Aave 連携を一時停止
  - 必要に応じて手動で Aave ダッシュボードから withdraw
  - 緊急停止条件（ヘルスファクター < 1.6 など）に該当する場合は「全停止＋通知」を優先

---

# 3. 本番環境のロールバック

## Aave 運用ロールバック

1. 自動運用停止  
2. 資金をステーブルコインに変換  
3. ウォレットへ退避  
4. LINE/Slack通知

---

# 4. バージョン管理ロールバック
GitHub：

- `main` のタグ管理  
- `rollback/vX.Y.Z` ブランチの作成  
- 前バージョンをデプロイ可能

---

# 5. 緊急停止（Emergency Mode）

### 発火条件例
- 価格変動 > 20%  
- ヘルスファクター < 1.6  
- OctoBot応答なし  
- AI API失敗率 > 20%  

### 発動後
- 全処理停止  
- Aave withdraw  
- 通知