
---

## 3. `docs/19_operations_runbook.md` 新規作成案

```md
# 19_operations_runbook.md
Ultra AutoTrade – 運用ランブック（staging 版）

本ドキュメントは、Ultra AutoTrade の運用担当者が  
日常運用や障害対応を行う際の「手順書（Runbook）」である。

Phase7 時点では **staging 環境** を対象とし、  
将来的に production 版を拡張する前提とする。

---

## 1. 役割と前提

- 対象読者
  - インフラ担当
  - アプリケーション運用担当
- 対象環境
  - Ultra AutoTrade – staging 環境（Hetzner 等）
- 前提
  - インフラ構成とデプロイ手順は `16_infra_deployment_guide.md` に準拠
  - ジョブスケジュールは `18_scheduler_and_cron.md` に準拠
  - セキュリティポリシーは `13_security_design.md` に準拠

---

## 2. 日常運用フロー

### 2.1 毎日のチェック項目（例）

1. **通知チャネルの確認**
   - LINE / Slack などに異常通知が来ていないか確認する。
   - 日次レポートが想定時刻（毎日 00:30 頃）に届いているか確認する。

2. **ログのざっと確認**
   - `/var/log/ultra/backup_daily.log`
   - `/var/log/ultra/monitor_daily.log`
   - `/var/log/ultra/healthcheck.log`
   の最新行を確認し、明らかなエラーがないかを見る。

3. **ヘルスチェック**
   - 必要に応じて、手動で `/health` を叩いてレスポンスを確認する：
     ```bash
     curl -fsS http://localhost:8000/health
     ```

### 2.2 週次のチェック項目（例）

1. **週次レポートの確認**
   - `monitor_weekly` の結果（週次レポート）が正しく生成・通知されているか確認する。
2. **バックアップの状態確認**
   - バックアップ先（ローカル / 外部ストレージ）の容量と、最新ファイルの日付を確認する。
3. **ログ容量の確認**
   - `/var/log/ultra` の容量を確認し、過大であれば logrotate 設定を見直す。

---

## 3. 異常検知時の基本フロー

### 3.1 通知からの起点

異常は、主に以下の経路から検知されることを想定する：

- 通知チャネルへのエラーメッセージ
- 日次 / 週次レポート内の異常値
- 外部監視サービスからのダウン通知
- 手動チェック中のエラーログ発見

### 3.2 フロー（高レベル）

1. **緊急度の確認**
   - トレードに直接影響するか？
   - Aave ポジションのリスクレベルは？
   - 単なる一時的な外部サービスエラーか？

2. **緊急停止フラグの検討**
   - 重大な金銭的リスクがある、またはトレードロジックがおかしい場合は、
     **すぐに緊急停止フラグを ON** にする。
   - 軽微なログエラーの場合は、状況を見ながら対応。

3. **状態の確認**
   - `/health` レスポンス
   - コンテナ / サービス状態（`docker ps` or `systemctl status`）
   - 監視ログ・バックアップログ

4. **原因の切り分け**
   - 外部サービス（Notion / OctoBot / RPC）の障害か？
   - コード変更の影響か？
   - インフラ（サーバ / ネットワーク / DNS）の問題か？

5. **対応の決定**
   - 単純再起動で解決するか？
   - ロールバックが必要か？（`15_rollback_procedures.md` 参照）
   - 一時的にジョブを止める必要があるか？

6. **対応後の確認と記録**
   - 再度 `/health` / テストフローで正常に動作するか確認
   - 対応内容と結果を運用メモに残す

---

## 4. 緊急停止フラグの運用

### 4.1 概要

緊急停止フラグ（emergency stop）は、  
「**自動トレードを即時停止** するための安全装置」である。

- ON（有効）：
  - トレード系アクション（Aave での実トランザクション）をブロック
- OFF（無効）：
  - 通常どおり自動トレードを実行

実際のフラグ管理場所（例：Notion データベースのプロパティ / 設定テーブル）は、  
`09_notion_schema.md` およびコード実装に従う。

### 4.2 誰が操作してよいか（権限イメージ）

- ON（停止）
  - インフラ担当 / 運用責任者 クラス
- OFF（再開）
  - インフラ担当 / 運用責任者
  - 原則として、原因が解消されたことを確認した上で行う

### 4.3 ON にするタイミングの例

- Aave 側ポジションが危険水準（Health Factor が閾値以下）に落ち込んだ
- OctoBot からのシグナルが明らかに異常（短時間で大量など）
- バグ・誤った設定変更により、トレード結果が想定と大きく異なる
- 開発チームが「このバージョンは危険」と判断した場合

### 4.4 OFF にするまでのチェックリスト（簡易）

1. エラー原因が特定されている
2. 必要であればロールバック・再デプロイが完了している
3. staging でテストフローが成功している
4. 監視・バックアップに問題が出ていない
5. 関係者と認識が合っている（可能であれば 2 名以上で確認）

---

## 5. 連絡・エスカレーション

※ 実際の組織名・個人名は記載せず、抽象的なレベルで定義する。

### 5.1 障害レベル（例）

- **S1（重大）**
  - トレードロジックの暴走
  - Aave ポジション喪失リスク
  - セキュリティインシデントが疑われる場合
- **S2（中）**
  - 一部機能障害（レポート生成失敗、OctoBot 連携不調など）
  - ただし資金リスクは限定的
- **S3（小）**
  - 軽微なログエラー / 一時的な外部サービスエラー

### 5.2 レベルごとの対応方針（例）

- S1：
  - 即座に緊急停止フラグ ON
  - インフラ担当・開発担当へ即時連絡
  - ロールバックも視野に入れて対応開始
- S2：
  - 状況を確認しつつ、必要に応じて緊急停止フラグ ON を検討
  - 通常営業時間内での対応でもよいが、放置しない
- S3：
  - 日次の運用時間内に対応
  - 影響が広がらない限り、緊急停止は不要

---

## 6. 今後の拡張

本ランブックは Phase7 時点の **staging 運用** を前提としている。  
production への展開時には、以下の項目を拡張・更新する必要がある。

- 本番用エスカレーションルール（24/7 対応など）
- 本番用バックアップポリシー（保持期間 / 暗号化）
- 本番用の監査ログ保存・コンプライアンス要件

これらは本番フェーズ以降で別途定義する。

## 7. 本番環境の定期ヘルスチェック

本番環境では、以下の観点で **定期的（例：毎日 / 毎週）** にヘルスチェックを行う。

### 7.1 アプリケーションレベル

- [ ] backend API に対して、read-only なエンドポイントで疎通確認
- [ ] ログに重大なエラーが継続的に出ていないことを確認
- [ ] スケジューラ（cron / 自動ジョブ）が想定どおり動作している

### 7.2 連携サービス

- [ ] Notion API への read-only アクセスが正常
- [ ] OctoBot へのシグナル送信 / ヘルスチェックが正常
- [ ] Aave RPC のレスポンスが安定している（タイムアウト・エラーが多発していない）

### 7.3 監視・通知

- [ ] 主要なアラート（プロセス死活・例外多発など）が正しく設定されている
- [ ] LINE / Slack / Webhook などで、テスト通知が正常に届く
- [ ] 監視設定が `docs/08_automation_rules.md` / `docs/18_scheduler_and_cron.md` と整合している

## 8. 本番リリース手順（運用担当者向け）

本番リリースは、次のドキュメントを前提として行う：

- テスト戦略：`docs/14_test_strategy.md`
- staging リリースチェックリスト：`docs/20_staging_release_checklist.md`
- 本番リリースチェックリスト：`docs/22_production_release_checklist.md`
- ロールバック手順：`docs/15_rollback_procedures.md`

### 8.1 リリース前の準備

- [ ] `20_staging_release_checklist.md` が完了している
- [ ] `22_production_release_checklist.md` の「前提条件チェック」を満たしている
- [ ] `.env.production` が最新状態であることを確認した
- [ ] ロールバック手順（`15_rollback_procedures.md`）をリリース担当者が事前に読み直した

### 8.2 デプロイ作業

- 通常は `scripts/deploy_production_backend.sh` を実行する：
  - [ ] 実行前に、対象ブランチ / タグが正しいことを確認
  - [ ] スクリプト実行ログ（開始〜終了）を必ず保存する

### 8.3 リリース後の確認

- [ ] backend コンテナ / プロセスが稼働している
- [ ] スモークテスト（API疎通、Notion → backend の軽いテスト等）が成功している
- [ ] ログに重大なエラーが出ていない
- [ ] 1〜2 時間ほどモニタリングを継続し、異常がないことを確認

## 9. インシデント対応・緊急停止（production 向け補足）

### 9.1 Aave 側の運用停止

- 本番資金に影響が出る可能性がある場合、まず「新規トレードを止める」ことを最優先とする
- 具体的な停止方法（例）：
  - Aave 側で手動ポジション調整を行う
  - OctoBot 側のシグナルを一時停止する
  - backend 側の「緊急停止フラグ」を ON にする（実装済みであれば）

※ 具体的な操作内容は、Aave 運用ロジック (`docs/07_aave_operation_logic.md`) と  
　緊急停止仕様に従う。

### 9.2 API キー漏えい時の対応

- `.env.production` の漏えいが疑われる場合：
  - [ ] 該当する API キー・トークン・秘密鍵を直ちにローテーション
  - [ ] 古いキーをすべて無効化（Notion / OctoBot / Aave / 通知サービス側）
  - [ ] ログ・ブロックチェーン履歴等を確認し、不正取引や不正アクセスがないか調査
  - [ ] 調査内容と対応履歴を記録し、必要に応じて関係者に共有

- キーのローテーション後、`docs/21_production_environment_config.md` の内容が  
  新しい設定と整合しているかを確認する。
