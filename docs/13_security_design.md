# 13_security_design.md  
Ultra AutoTrade – セキュリティ設計書（完全版）

本ドキュメントは、Notion → AI → OctoBot → Aave という自動運用システムにおいて  
「資金を失わない」「GPTの自動生成コードが安全に実行できる」ことを目的に作成する。

---

# 1. APIキー管理（Notion / AI / OctoBot / Aave）

## 1.1 APIキーの保存場所
- すべて「環境変数」で管理する  
- `.env` を使用する場合は **必ず .gitignore に追加**
- GitHub に push される形で保存してはならない

## 1.2 本番／開発キーの分離
- `NOTION_API_KEY_PROD`
- `NOTION_API_KEY_DEV`
- `AAVE_PRIVATE_KEY_PROD`
- `AAVE_PRIVATE_KEY_DEV`

誤用を防ぐため、環境切替フラグを導入：

```
APP_ENV=dev | prod
```

---

# 2. 秘密鍵の保護（Aave運用）

## 2.1 原則
- Aave運用に使用する秘密鍵は **最低限の金額のみ保持した専用ウォレット**  
- 運用額に応じてウォレットを分割（資産集中を避ける）

## 2.2 ハードウェアウォレットの推奨
本番環境では可能であれば **Ledger などの HW Wallet を使用**。

## 2.3 マルチシグ設定（任意）
- Gnosis Safe を利用し、運用の大きなアクションは multi-sig による承認を必要とする

---

# 3. 操作額制限（スマートコントラクト保護）

```
・1回の最大投資額：総資産の 10% 以内  
・1日最大投資額：総資産の 30% 以内  
・自動売買は 10分間に 1回まで  
```

---

# 4. 通信暗号化ポリシー

- すべて HTTPS / TLS
- API通信ログには資格情報を含めない
- Webhook / OctoBot API は IP 制限を設定（安全な IP のみ許可）

---

# 5. ログのサニタイズ（匿名化）

ログに以下を出してはならない：

- トークン
- APIキー
- 秘密鍵
- 生のウォレットアドレス（必要に応じて先頭6文字＋末尾4文字）

---

# 6. セキュリティ自動化

- エラー多発時に自動停止
- AI判定が異常値連続（例：BUY or SELL が5回連続）→ 停止
- Aaveヘルスファクター < 1.6 → 運用ストップ通知

---

# 7. 緊急停止（Emergency Stop）

```
・AI API エラー率 > 20%  
・OctoBot 応答なし 3回連続  
・Aave Gas エラー 2回連続  
・価格変動 > 20% / 1日  
```

該当したら自動的に：

- Aave から資金を引き出し
- 運用停止
- LINE / Slack へ通知

---

# 8. バージョン管理のセキュリティ

- GitHub Personal Token を使用（classic は禁止）
- SSH 認証必須
- main ブランチへの push は禁止（PR必須）